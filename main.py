
import argparse
import pickle
import sys
from typing import Union
from pathlib import Path
from unittest import result

import numpy as np
from malgan import MalGAN, MalwareDataset, BlackBoxDetector, setup_logger

import torch
from torch import nn
from script import genscript

z = 10
batch_size = 32
num_epochs = 100
hidden_size_gen = [256, 256]
hidden_size_dis = [256, 256]

api_map_to_index = {
    "terminate_process": 0,
    "get_file_info": 1,
    "write_console": 8,
    "get_short_path_name": 11,
    "get_temp_dir": 20,
    "get_file_info": 22,
    "get_file_info": 23,
    "get_file_info": 28,
    "create_directory": 34,
    "get_system_directory": 37,
    "get_file_info": 42,
    "get_file_info": 44,
    "get_time": 49,
    "delete_file": 57,
    "get_file_info": 58,
    "write_file": 59,
    "read_file": 60,
    "get_file_info": 63,
    "write_file": 75,
    "get_computer_name": 83,
    "get_file_info": 84,
    "read_file": 91,
    "read_file": 92,
    "get_system_directory": 93,
    "get_system_directory": 95,
    "get_file_info": 113,
    "get_computer_name": 117,
    "get_time": 121,
    "get_file_info": 127,
    "copy_file": 125,
    "write_console": 134,
    "get_system_directory": 140,
    "get_username": 149,
    "get_file_info": 153,
    "get_username": 156,
    "set_file_time": 161,
    "copy_file": 162,
    "copy_file": 165,
    "get_username": 167,
    "get_username": 168,
    "remove_directory": 178,
    "get_free_disk_space": 183,
    "remove_directory": 184,
    "get_system_directory": 210,
    "download_file": 214,
    "get_free_disk_space": 215,
    "create_directory": 242,
    "download_file": 248,
    "delete_file": 254,
    "get_file_info": 259
}

def load_dataset(file_path: Union[str, Path], y: int) -> MalwareDataset:
    file_ext = Path(file_path).suffix
    if file_ext in {".npy", ".npz"}:
        data = np.load(file_path)
    elif file_ext in {".pt", ".pth"}:
        data = torch.load(str(file_path))
    elif file_ext == ".pk":
        with open(str(file_path), "rb") as f_in:
            data = pickle.load(f_in)
    else:
        raise ValueError("Unknown file extension.  Cannot determine how to import")
    return MalwareDataset(x=data, y=y)


def main(z, batch_size, num_epochs, hidden_size_gen, hidden_size_dis, list_of_apis_to_use=None):
    if list_of_apis_to_use is None:
        list_of_apis_to_use = []


    setup_logger(False)

    here = Path(__file__).absolute().parent
    # mal_file = here / "data/benign.csv"
    # ben_file = here / "data/malware.csv"

    mal_file = here / "data/trial_mal.npy"
    ben_file = here / "data/trial_ben.npy"

    
    detector = BlackBoxDetector.Type.get_from_name(BlackBoxDetector.Type.RandomForest.name)
    
    for (name, path) in (("malware", mal_file), ("benign", ben_file)):
        if path.exists():
            continue
        print(f"Unknown %s file \"%s\"" % (name, str(path)))
        sys.exit(1)

    MalGAN.MALWARE_BATCH_SIZE = batch_size

    malgan = MalGAN(
                    load_dataset(mal_file, MalGAN.Label.Malware.value),
                    load_dataset(ben_file, MalGAN.Label.Benign.value),
                    Z=z,
                    h_gen=hidden_size_gen,
                    h_discrim=hidden_size_dis,
                    g_hidden=nn.LeakyReLU,
                    detector_type=detector)
                    

    malgan.fit(num_epochs, False)
    result = malgan.measure_and_export_results()
    print(result)

    malgan = malgan.cpu()

    binary_array, _ = malgan(next(iter(malgan._mal_data.test))[0][:1])
    array = binary_array.flatten().cpu().numpy()

    for func in list_of_apis_to_use:
        index = api_map_to_index[func]

        if index < 128:
            array[index] = 1

    genscript.generate(array)



if __name__ == "__main__":
    main(z, batch_size, num_epochs, hidden_size_gen, hidden_size_dis, None)
